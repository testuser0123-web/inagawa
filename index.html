<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Button</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
      <div id="counter-display" class="inagawa">0円</div>
      <h1 class="title"><span>みぬき</span>ボタン</h1>
      <div class="tkmk-button">
          <div id="tkmkBtnVisual" class="Btn-visual">
              <span class="layer btn-hole">
                <img src="./assets/btn-hole.png" alt="" aria-hidden="true">
              </span>
              <span class="layer btn-top">
                <img src="./assets/btn-top.png" alt="" aria-hidden="true">
              </span>
              <span class="layer btn-btm">
                <img src="./assets/btn-btm.png" alt="" aria-hidden="true">
              </span>
              <span id="btnpush" class="layer btn-main">
                <img src="./assets/btn-main.png" alt="" aria-hidden="true">
              </span>
          </div>
          <div class="real-btn"></div>
      </div>
      <p class="swap-text">jΣﾐｲ˶º ᴗº˶ﾘ　ᶘｲ^⇁^ﾅ川</p>
      <p class="effect-text"><bt><span>₊</span><span>˚</span><span>⊹</span><span>.</span><span>*</span><span> </span><span>♡</span><span> </span><span>*</span><span>.</span><span>⊹</span><span>˚</span><span>₊</span>
    &lpar;⊃∩⊂&rpar;</p>
    </div>

    <script>
        const btnPush = document.getElementById('btnpush');
        const realBtn = document.querySelector('.real-btn');
        const counterDisplay = document.getElementById('counter-display');
        const swapTextElement = document.querySelector('.swap-text'); // Get the new swap element

        // Helper to format the number
        const formatCurrency = (num) => {
          if (typeof num !== 'number') return '---';
          return `${num.toLocaleString()}円`;
        };

        // On page load, setup DB and get initial count
        document.addEventListener('DOMContentLoaded', async () => {
          // This part will only work when running with a server (like `vercel dev`)
          // that can run the /api functions.
          try {
            await fetch('/api/setup-database', { method: 'POST' });
            const response = await fetch('/api/get-count');
            const data = await response.json();
            if (counterDisplay) {
              counterDisplay.textContent = formatCurrency(data.count);
            }
          } catch (error) {
            console.error("Counter feature requires a server environment (like 'vercel dev') to run.", error);
            if (counterDisplay) {
              counterDisplay.textContent = "サーバー接続エラー";
            }
          }
        });

        if (realBtn && btnPush) {
            const pushButton = async () => {
                btnPush.classList.add('pushed');

                // 1. Trigger text animation
                const effectText = document.querySelector('.effect-text');
                if (effectText) {
                  effectText.classList.remove('start-animation');
                  setTimeout(() => {
                    effectText.classList.add('start-animation');
                  }, 10);
                }

                // 2. Handle swap-text change
                if (swapTextElement) {
                  const originalSwapText = 'jΣﾐｲ˶º ᴗº˶ﾘ　ᶘｲ^⇁^ﾅ川';
                  const newSwapText = 'jΣﾐｲ˶^ ᴗ^˶ﾘ　ᶘｲ>⇁<ﾅ川';
                  swapTextElement.textContent = newSwapText;
                  setTimeout(() => {
                    swapTextElement.textContent = originalSwapText;
                  }, 1700); // Sync with effect-text animation duration
                }

                // 3. Increment counter via API
                try {
                  const response = await fetch('/api/increment-count', { method: 'POST' });
                  const data = await response.json();
                  if (counterDisplay) {
                    counterDisplay.textContent = formatCurrency(data.count);
                  }
                } catch (error) {
                  console.error("Failed to increment counter. Is the server running?", error);
                }
            };

            const releaseButton = () => {
                btnPush.classList.remove('pushed');
            };

            realBtn.addEventListener('mousedown', pushButton);
            realBtn.addEventListener('mouseup', releaseButton);
            realBtn.addEventListener('mouseleave', releaseButton);

            realBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                pushButton();
            }, { passive: false });
            realBtn.addEventListener('touchend', releaseButton);
        }
    </script>
</body>
</html>